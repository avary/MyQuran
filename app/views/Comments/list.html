#{extends 'main.html' /}
#{set title:'coran.al-imane.org - Mes commentaires' /}

<script src="@{'/public/javascripts/tiny_mce.js'}" type="text/javascript" charset='utf-8'></script>

#{i18n /}

<script>

    function showCommentBox(id,ayatId){

        $("#"+id).append("<span id='check_"+id+"' style='display:none></span>'");

        tinyMCE.init({

            mode : "specific_textareas",
            editor_selector : "comment_"+id,

            plugins : "save",
            theme : "advanced",
            theme_advanced_buttons1 : "save,|,bold,italic,underline,strikethrough,forecolor,|,justifyleft,justifycenter,justifyright,justifyfull",
            theme_advanced_buttons2 : "",
            theme_advanced_buttons3 :"",
            theme_advanced_buttons4 :"",
            theme_advanced_toolbar_location : "top",
            theme_advanced_toolbar_align : "left",
            theme_advanced_statusbar_location : "bottom",
            theme_advanced_resizing : true,
            cleanup: false,
            convert_fonts_to_spans : false,
            inline_styles: false,
            fix_table_elements : true,
            fix_list_elements : true,
            relative_urls : false,
            convert_urls : false,
            extended_valid_elements :
                "a[href|rel|rev|target|title|type]," +
                "b[],"+
                "blink[],"+
                "blockquote[align|cite|clear|height|type|width],"+
                "br[clear],"+
                "caption[align|height|valign|width],"+
                "center[align|height|width],"+
                "col[align|bgcolor|char|charoff|span|valign|width],"+
                "colgroup[align|bgcolor|char|charoff|span|valign|width],"+
                "comment[],"+
                "em[],"+
                "font[color|face|font-weight|point-size|size],"+
                "h1[align|clear|height|width],"+
                "h2[align|clear|height|width],"+
                "h3[align|clear|height|width],"+
                "h4[align|clear|height|width],"+
                "h5[align|clear|height|width],"+
                "h6[align|clear|height|width],"+
                "hr[align|clear|color|noshade|size|width],"+
                "img[align|alt|border|height|hspace|src|vspace|width],"+
                "li[align|clear|height|type|value|width],"+
                "marquee[behavior|bgcolor|direction|height|hspace|loop|scrollamount|scrolldelay|vspace|width],"+
                "ol[align|clear|height|start|type|width],"+
                "p[align|clear|height|width],"+
                "pre[clear|width|wrap],"+
                "s[],"+
                "small[],"+
                "span[align],"+
                "strike[],"+
                "strong[],"+
                "sub[],"+
                "sup[],"+
                "table[align|background|bgcolor|border|bordercolor|bordercolordark|bordercolorlight|"+
                "bottompadding|cellpadding|cellspacing|clear|cols|height|hspace|leftpadding|"+
                "rightpadding|rules|summary|toppadding|vspace|width],"+
                "tbody[align|bgcolor|char|charoff|valign],"+
                "td[abbr|align|axis|background|bgcolor|bordercolor|"+
                "bordercolordark|bordercolorlight|char|charoff|headers|"+
                "height|nowrap|rowspan|scope|valign|width],"+
                "tfoot[align|bgcolor|char|charoff|valign],"+
                "th[abbr|align|axis|background|bgcolor|bordercolor|"+
                "bordercolordark|bordercolorlight|char|charoff|headers|"+
                "height|nowrap|rowspan|scope|valign|width],"+
                "thead[align|bgcolor|char|charoff|valign],"+
                "tr[align|background|bgcolor|bordercolor|"+
                "bordercolordark|bordercolorlight|char|charoff|"+
                "height|nowrap|valign],"+
                "tt[],"+
                "u[],"+
                "ul[align|clear|height|start|type|width]"


        });
    }

    function showTranslationBox(id,ayatId){

        $("#ayat_translation_"+id).html('<textarea id="translation_'+id+'" class="translation_'+id+'" cols="80" rows="8"></textarea>');


        tinyMCE.init({

            mode : "specific_textareas",
            editor_selector : "translation_"+id,

            plugins : "save",
            theme : "advanced",
            theme_advanced_buttons1 : "save,|,bold,italic,underline,strikethrough,forecolor,|,justifyleft,justifycenter,justifyright,justifyfull",
            theme_advanced_buttons2 : "",
            theme_advanced_buttons3 :"",
            theme_advanced_buttons4 :"",
            theme_advanced_toolbar_location : "top",
            theme_advanced_toolbar_align : "left",
            theme_advanced_statusbar_location : "bottom",
            theme_advanced_resizing : true,
            cleanup: false,
            convert_fonts_to_spans : false,
            inline_styles: false,
            fix_table_elements : true,
            fix_list_elements : true,
            relative_urls : false,
            convert_urls : false,
            extended_valid_elements :
                "a[href|rel|rev|target|title|type]," +
                "b[],"+
                "blink[],"+
                "blockquote[align|cite|clear|height|type|width],"+
                "br[clear],"+
                "caption[align|height|valign|width],"+
                "center[align|height|width],"+
                "col[align|bgcolor|char|charoff|span|valign|width],"+
                "colgroup[align|bgcolor|char|charoff|span|valign|width],"+
                "comment[],"+
                "em[],"+
                "font[color|face|font-weight|point-size|size],"+
                "h1[align|clear|height|width],"+
                "h2[align|clear|height|width],"+
                "h3[align|clear|height|width],"+
                "h4[align|clear|height|width],"+
                "h5[align|clear|height|width],"+
                "h6[align|clear|height|width],"+
                "hr[align|clear|color|noshade|size|width],"+
                "img[align|alt|border|height|hspace|src|vspace|width],"+
                "li[align|clear|height|type|value|width],"+
                "marquee[behavior|bgcolor|direction|height|hspace|loop|scrollamount|scrolldelay|vspace|width],"+
                "ol[align|clear|height|start|type|width],"+
                "p[align|clear|height|width],"+
                "pre[clear|width|wrap],"+
                "s[],"+
                "small[],"+
                "span[align],"+
                "strike[],"+
                "strong[],"+
                "sub[],"+
                "sup[],"+
                "table[align|background|bgcolor|border|bordercolor|bordercolordark|bordercolorlight|"+
                "bottompadding|cellpadding|cellspacing|clear|cols|height|hspace|leftpadding|"+
                "rightpadding|rules|summary|toppadding|vspace|width],"+
                "tbody[align|bgcolor|char|charoff|valign],"+
                "td[abbr|align|axis|background|bgcolor|bordercolor|"+
                "bordercolordark|bordercolorlight|char|charoff|headers|"+
                "height|nowrap|rowspan|scope|valign|width],"+
                "tfoot[align|bgcolor|char|charoff|valign],"+
                "th[abbr|align|axis|background|bgcolor|bordercolor|"+
                "bordercolordark|bordercolorlight|char|charoff|headers|"+
                "height|nowrap|rowspan|scope|valign|width],"+
                "thead[align|bgcolor|char|charoff|valign],"+
                "tr[align|background|bgcolor|bordercolor|"+
                "bordercolordark|bordercolorlight|char|charoff|"+
                "height|nowrap|valign],"+
                "tt[],"+
                "u[],"+
                "ul[align|clear|height|start|type|width]"


        });
    }

    function saveComment(id,ayatId){
        $.post("@{Comments.save()}", { ayatId: ayatId,content:tinyMCE.get("comment_ayat_"+id).getContent() },
        function(data){

            $("#message_"+id).html(i18n("comment.add")+"<br/>");
            $("#message_"+id).removeClass("validation");
            $("#message_"+id).addClass("success");
            $("#message_"+id).show();
            window.setTimeout(function() {
                $("#message_"+id).fadeOut('slow');
            }, 3000);
        });
    }

    function saveTranslation(id,ayatId){
        $.post("@{Translations.save()}", { ayatId: ayatId,translation:tinyMCE.get("translation_"+id).getContent() },
        function(data){
            if(data.result == 'ok'){
                $("#message_"+id).html(i18n("translation.add")+"<br/>");
                $("#message_"+id).removeClass("validation");
                $("#message_"+id).addClass("success");
                $("#message_"+id).show();
                window.setTimeout(function() {
                    $("#message_"+id).fadeOut('slow');
                }, 3000);
            }else{
                $("#message_"+id).html(i18n("translation.notAdd")+"<br/>");
                $("#message_"+id).removeClass("success");
                $("#message_"+id).addClass("validation");
                $("#message_"+id).show();
                window.setTimeout(function() {
                    $("#message_"+id).fadeOut('slow');
                }, 5000);
            }
        });
    }

    function showHideCommentBox(id,ayatId){

        if('${session.username}' == ''){
            alert(i18n("error.userNotConnected"));
            return;
        }

        if($('#check_'+id).length == 0){
            showCommentBox(id,ayatId);
            $("#"+id).toggle();
        }else{
            $("#"+id).toggle();
        }

    }

    function showHideTranslateBox(id,ayatId){
        if('${session.username}' == ''){
            alert(i18n("error.userNotConnected"));
            return;
        }

        if($('#translation_'+id).length == 0){
            showTranslationBox(id,ayatId);
            $("#ayat_translation_"+id).toggle();
        }else{
            $("#ayat_translation_"+id).toggle();
        }

    }

    function selectAyat(id,ayatId){
        if('${session.username}' == ''){
            alert(i18n("error.userNotConnected"));
            return;
        }

        $.post("@{Chapters.selectAyat()}", { ayatId: ayatId },
        function(data){
            if(data.result == 'ok'){
                $("#message_"+id).html(i18n("ayat.selected")+"<br/>");
                $("#message_"+id).removeClass("validation");
                $("#message_"+id).addClass("success");
                $("#message_"+id).show();
                window.setTimeout(function() {
                    $("#message_"+id).fadeOut('slow');
                }, 3000);
            }else{
                $("#message_"+id).html(i18n("ayat.alreadySelected")+"<br/>");
                $("#message_"+id).removeClass("success");
                $("#message_"+id).addClass("validation");
                $("#message_"+id).show();
                window.setTimeout(function() {
                    $("#message_"+id).fadeOut('slow');
                }, 3000);
            }
        });
    }

</script>

<h4>&{'comment.yourComment'} :</h4>

<table align="center" cellspacing="5px">
    <tr>
        <td colspan="3">
            <form action="@{Comments.listBySourat()}">
                &{'info.selectSourat'} :
                <select name="id" >
                    <option value="-1" ${id == -1?"selected='selected'":""}>Toutes</option>
                    #{list items:sourats, as:'sourat'}
                    <option value="${sourat.id}" ${id == sourat.id?"selected='selected'":""}>${sourat.number}.${sourat.title}</option>
                    #{/list}
                </select>
                <input type="submit" name="see" value="&{'see'}"/>
            </form>
        </td>
    </tr>
    #{if nbPage > 1}

    <tr >
        #{if page > 1}
        <td>
            <a href="@{Comments.list(page-1)}">
                <img src="@{'/public/images/previous.png'}" width="20px" height="20px"/>
            </a>
        </td>
        #{/if}
        #{list items:1..nbPage, as:'i'}
        #{if page == i}
        <td valign="middle" align="center" id="currentPage">
            <strong>${i}</strong>
        </td>
        #{/if}
        #{else}
        <td valign="middle" align="center" id="page">
            <a href="@{Comments.list(i)}"  >
                ${i}
            </a>
        </td>
        #{/else}

        #{/list}

        #{if page < nbPage}
        <td>
            <a href="@{Comments.list(page+1)}">
                <img src="@{'/public/images/next.png'}" width="20px" height="20px"/>
            </a>
        </td>
        #{/if}
    </tr>
    #{/if}
</table>

<div style="border-bottom: 1px #eeeeee solid"></div>

#{list items:comments, as:'c'}

<div style="padding-bottom: 10px;padding-top: 10px;">
    <div id="message_${c.ayat.id}"></div>
    <div style="display: inline-block;width: 70px;height: 80px">
        <div>
            <div id="ayatNumber">${c.ayat.sa}</div>
            <div style="padding-top: 3px;">
                <a href="#top">
                    <img src="@{'/public/images/up.png'}" title="&{'ayat.top'}" width="20px" height="20px"/>
                </a>
                <a href="#" id="link_${c.ayat.id}" onclick="showHideCommentBox('ayat_${c.ayat.id}','${c.ayat.id}');return false;">
                    <img src="@{'/public/images/comment.png'}" title="&{'ayat.comment'}" width="20px" height="20px"/>
                </a>
            </div>
            <div>
                <a href="#" onclick="selectAyat('${c.ayat.id}','${c.ayat.id}');return false;">
                    <img src="@{'/public/images/select.png'}" title="&{'ayat.select'}" width="20px" height="20px"/>
                </a>
                #{if session.username}
                #{secure.check 'admin'}
                <a href="@{Ayats.editAyat(c.ayat.id)}">
                    <img src="@{'/public/images/idea.png'}" title="&{'ayat.suggest'}" width="20px" height="20px"/>
                </a>
                #{/secure.check}
                #{secure.check 'user'}
                <a href="#" onclick="showHideTranslateBox('${c.ayat.id}','${c.ayat.id}');return false;">
                    <img src="@{'/public/images/idea.png'}" title="&{'ayat.suggest'}" width="20px" height="20px"/>
                </a>
                #{/secure.check}
                #{/if}
                #{else}
                <a href="#" onclick="showHideTranslateBox('${c.ayat.id}','${c.ayat.id}');return false;">
                    <img src="@{'/public/images/idea.png'}" title="&{'ayat.suggest'}" width="20px" height="20px"/>
                </a>
                #{/else}
            </div>
        </div>
    </div>

    <div id="ayatContent" >${c.ayat.content}</div>
    <form action="" onsubmit="saveComment('${c.ayat.id}','${c.ayat.id}');return false;">
        <div class="ayatComment" id="ayat_${c.ayat.id}" >
            <textarea id="comment_ayat_${c.ayat.id}" class="comment_ayat_${c.ayat.id}" cols="80" rows="8">
                ${c.content}
            </textarea>
        </div>
    </form>

    <form action="" onsubmit="saveTranslation('${c.ayat.id}','${c.ayat.id}');return false;">
        <div class="ayatComment" id="ayat_translation_${c.ayat.id}" ></div>
    </form>

</div>


<div style="border-bottom: 1px #eeeeee solid"></div>

#{/list}